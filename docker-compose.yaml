services:
  # üîê VAULT SERVICE
  vault:
    image: hashicorp/vault:latest
    container_name: sovereign_vault
    ports:
      - "8200:8200"
    volumes:
      - ./vault/config:/vault/config:rw
      - ./vault/data:/vault/file:rw
      - ./certs:/vault/certs:ro
    environment:
      VAULT_CACERT: '/vault/certs/ca.pem'
    command: sh /vault/config/run-vault.sh
    cap_add:
      - IPC_LOCK
    networks:
      - sovereign-net

  # üóÑÔ∏è DATABASE SERVICE (SQL Server)
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sovereign_db
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=StrongPassword123!
    ports:
      - "1433:1433"
    volumes:
      - db_data:/var/opt/mssql
    networks:
      - sovereign-net

  # ‚öôÔ∏è BACKEND SERVICE
  backend:
    build: ./backend
    container_name: sovereign_backend
    restart: always
    ports:
      - "5000:5000"
    environment:
      - PORT=5000
      - DATABASE_URL=sqlserver://host.docker.internal:1433;database=RealEstate;user=Tariq;password=abc123;encrypt=false;trustServerCertificate=true
      - VAULT_ADDR=http://sovereign_vault:8200
      # Add other env vars as needed from .env
    depends_on:
      - db
      - vault
    networks:
      - sovereign-net

  # üé® FRONTEND SERVICE (Next.js)
  frontend:
    build: ./frontend-next
    container_name: sovereign_frontend
    restart: always
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:5000/api/v1
    depends_on:
      - backend
    networks:
      - sovereign-net

  # üìä PROMETHEUS (Monitoring)
  prometheus:
    image: prom/prometheus:latest
    container_name: sovereign_prometheus
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    ports:
      - "9090:9090"
    networks:
      - sovereign-net

  # üìà GRAFANA (Visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: sovereign_grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    depends_on:
      - prometheus
    networks:
      - sovereign-net

volumes:
  db_data:
  grafana_data:


networks:
  sovereign-net:
    driver: bridge
